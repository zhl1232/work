# 下一步计划与路线图

## 🚀 未来功能

### 社交互动

- [x] **用户关注系统**：允许用户关注创作者并在动态流中查看他们的更新（已在移动端实现）。
- [x] **私信系统**：用户之间用于协作的简单消息系统。

### 游戏化

- [x] **动态徽章体系 (Dynamic Badges)**
  - **设计目标**: 打造具有收藏价值和成就感的成长体系。
  - **视觉风格推荐**: **3D / 玻璃拟态 (Glassmorphism)**。相比扁平化，3D 质感配合动态光效能带来更强的“获得感”和“高级感”，符合 Wow 的设计原则。
  - **现状**: 项目已定义 **112 个徽章** (`lib/gamification/badges.ts`)，其中 **102 个** 为阶梯式可升级设计，**15 个** 为单档或手动授予。当前各系列档位数量不统一（5～11 档），与 铜/银/金/白金 四档设计不匹配。
  - **徽章总览**:

    **阶梯式可升级（规划收敛为 铜/银/金/白金 四档）**

    | 系列 | 度量 | 铜 | 银 | 金 | 白金 |
    |------|------|-----|-----|-----|------|
    | 🎯 入门·点赞 | 累计点赞数 | 1 | 10 | 50 | 200 |
    | 🎯 入门·评论 | 累计评论数 | 1 | 10 | 50 | 200 |
    | 🎯 入门·发布 | 累计发布数 | 1 | 5 | 10 | 30 |
    | 🎯 入门·收藏 | 累计收藏数 | 1 | 10 | 50 | 200 |
    | 🔬 科学专家 | 科学类完成数 | 5 | 20 | 50 | 100 |
    | 💻 技术达人 | 技术类完成数 | 5 | 20 | 50 | 100 |
    | ⚙️ 工程师 | 工程类完成数 | 5 | 20 | 50 | 100 |
    | 🎨 艺术家 | 艺术类完成数 | 5 | 20 | 50 | 100 |
    | 🔢 数学家 | 数学类完成数 | 5 | 20 | 50 | 100 |
    | 📝 创作者 | 发布项目数 | 1 | 5 | 10 | 50 |
    | 💬 社交达人 | 评论+回复总数 | 10 | 50 | 200 | 500 |
    | ❤️ 人气之星 | 收到赞数 | 10 | 100 | 500 | 2000 |
    | 🏆 成就里程碑 | 总完成数 | 5 | 25 | 100 | 500 |
    | 🌟 等级晋升 | 用户等级 | 5 | 25 | 50 | 100 |
    | 🎮 挑战赛 | 参加次数 | 3 | 10 | 50 | 100 |
    | 🔥 连续打卡 | 连续登录天数 | 3 | 7 | 30 | 90 |

    **单档 / 手动授予（保持现状）**

    | 系列 | 说明 |
    |------|------|
    | 👣 首步成就 | 注册、首次参与讨论等一次性成就 |
    | 💎 稀有限定 | 平台先驱、漏洞猎人、贡献者、测试先锋、周年纪念（后端手动授予） |

  - **后续优化**: ① 将现有多档位徽章收敛为 铜/银/金/白金 四档；② 入门系列扩展为阶梯式（点赞/评论/发布/收藏）；③ 稀有限定系列保持手动授予。
- [x] **排行榜筛选 (Leaderboard System)**
  - **多维度视图**: 支持 **本周 (Weekly)** / **本月 (Monthly)** / **总榜 (All-time)** 切换（积分榜 Tab 下）。
  - **技术方案**: 使用物化视图 `mv_leaderboard_weekly_xp` / `mv_leaderboard_monthly_xp` 缓存本周/本月 XP 聚合；RPC `get_leaderboard_xp_weekly` / `get_leaderboard_xp_monthly` 供前端调用。刷新：`SELECT refresh_leaderboard_mvs();`，建议每小时执行（如 pg_cron 或定时任务）。
  - **讨论结论（头像光环）**: 不做「仅在排行榜内可见」的前三头像光环——离开排行榜就消失，身份感与收藏价值弱。改为将 **头像光环/头像框** 纳入 **积分商店与成就体系**：用户兑换或解锁后装备，在个人页、评论、动态、排行榜等所有出现头像处统一展示（见下「积分商店」商品规划）。
- [ ] **积分商店系统与双货币**
  - **设计结论**: 积分商店若直接消耗当前 XP，会与「等级 = f(当前 XP)」冲突（花 XP 会掉级）。采用 **双货币** 更清晰：
    - **XP（经验）**：只增不减，仅用于升级与等级，不参与消费、不参与投币。
    - **第二货币（如硬币/积分）**：可增可减，用于 **商店兑换** 与 **投币支持创作者**。
  - **硬币获取**（严格控制）: 仅 **每日登录/打卡** 发放 **2 硬币**，无其他获取渠道。与 XP 同源、同时发：在现有打卡逻辑的同一事务内写 `xp_logs` 并更新 `profiles.xp`，再写 `coin_logs`（`action_type = 'daily_login'`, `amount = 2`）并 `profiles.coins += 2`；防刷：同用户同日仅发一次。
  - **硬币花费**: ① **赞赏**：用户对创作者的某个作品打赏硬币，扣己方余额、加对方余额；**每个作品限 2 硬币**（该作品累计收到的打赏总额上限为 2）。② **商店**：兑换头像框/主题等。
  - **投币支持**: 项目页/个人页「投币支持」→ 扣自己余额、加对方余额；对方可用于继续投币或商店兑换。每个作品累计收到的打赏总额上限为 2 硬币。若未来做真实货币充值需单独考虑合规。
  - **商品规划**（用第二货币）:
    - 🖼️ **头像框 / 头像光环**: 霓虹光环、像素边框、节日限定框等。用户装备后在 **全站** 展示（个人页、评论、动态、排行榜等所有出现头像处），形成身份感与收藏价值。可选：成就/里程碑奖励（如「曾进入总榜前三」解锁限定光环）与商店兑换并行。
    - 🎨 **个人主页主题**: 解锁不同的背景色或纹理。
    - 📛 **昵称特效**: 聊天室或评论区的昵称颜色特效。

- [x] **连续打卡加成与每日小目标**
  - **现状**: 已有 **连续打卡统计**（`daily_check_in` RPC 更新连续/累计天数）和 **连续打卡徽章**（3/7/30/90 天）。
  - **已实现**: ① 打卡时根据连续天数发放 XP（基础 5 + 连签加成 min(连续天数, 20)，封顶 25）；② **每日小目标**：今日完成第 1 个项目 → 额外 +10 XP（`daily_goal_first_complete`）；③ **每周小目标**：评论/回复合计满 5 次 → 额外 +5 XP，当周仅一次（`weekly_goal_comments_5`）。均用 `xp_logs` 防重复。

- **游戏化扩展方向（讨论摘要）**
  - 排行榜多维度（本周/本月/总榜 + 物化视图）。头像光环/头像框纳入商店与成就体系（用户级、全站展示），不做仅排行榜内展示的前三光环。距离下一徽章/档位的进度提示。
  - 双货币 + 积分商店 + 投币支持（见上）。
  - 连续打卡 XP 加成、每日/每周小目标（见上）。
  - 可选：称号、徽章稀有度展示（全站 X% 拥有）、等级权益（如某级解锁高级筛选）、社区集体目标（如本周社区完成 1000 个项目达成奖励）。

### 内容

- [ ] **原生视频上传 (Native Video)**
  - **MVP 方案**: 使用 Supabase Storage 存储短视频 (限制 < 50MB)，客户端直接播放。
  - **进阶方案**: 对接 Mux 或 Cloudflare Stream 处理转码和流式传输 (HLS)，适应弱网环境。
- [ ] **富文本编辑器 (Rich Text Editor)**
  - **技术选型**: 推荐 **Tiptap** (基于 ProseMirror)。它无头(Headless)且灵活，完美适配 React。
  - **功能增强**:
    - 支持 **Markdown** 快捷语法输入。
    - **拖拽上传图片** (集成 Supabase Storage)。
    - **代码块高亮** (集成 PrismJS/Lowlight)。

## 🛠 技术债与改进

### 类型安全

- [x] **严格空值检查**：在 `tsconfig.json` 中启用 `strictNullChecks` 并修复产生的错误。
- [x] **Zod 验证**：使用 Zod 对 Supabase 响应和表单输入进行运行时验证。

### 测试

- [ ] **集成测试 (Integration Tests)**
  - **工具链**: 使用 **Playwright** 进行端到端 (E2E) 测试。
  - **策略**: 针对本地 Supabase 实例运行测试，覆盖核心路径 (注册 -> 创建项目 -> 评论互动)。
  - **数据模拟**: 编写 Seed 脚本，确保测试环境数据一致性。
- [ ] **CI/CD 流水线 (Automation)**
  - **GitHub Actions**:
    - **PR Check**: 自动运行 `Type Check`, `Lint`, `Build` 检查。
    - **Preview**: 自动部署 Vercel 预览环境 (针对每个 PR)。
    - **Release**:合并到 main 分支后自动打 Tag 并部署生产环境。
